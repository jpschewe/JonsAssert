<?xml version="1.0"?>
<!DOCTYPE project PUBLIC "-//ANT//DTD project//EN" "project.dtd">

<project name="assert" default="compile" basedir=".">

  <property file="${user.home}/.ant.properties" />
  <property name="temp.dir"  value="${basedir}/tmp" />
  
  <property name="app.name"   value="JonsAssert" />
  <property name="instrument.dir"  value="instrumented" />

  <target name="init">
    <tstamp />
    <uptodate property="buildJavaLexer" targetfile="${basedir}/src/net/mtu/eggplant/assert/java.g">
      <srcfiles dir="${basedir}/src/net/mtu/eggplant/assert" includes="JavaLexer.java" />
    </uptodate>
    <uptodate property="buildAssertLexer" targetfile="${basedir}/src/net/mtu/eggplant/assert/assert.g">
      <srcfiles dir="${basedir}/src/net/mtu/eggplant/assert" includes="AssertLexer.java" />
    </uptodate>
  </target>

  <path id="base.classpath">
    <pathelement location="${basedir}/lib/JonsInfra-0.1.jar"/>
    <pathelement location="${basedir}/lib/antlr.jar"/>
    <pathelement location="${basedir}/lib/werken.opt.jar"/>
    <pathelement location="${basedir}/lib/junit-3.6.jar"/>
  </path>


  <target name="buildJavaLexer" if="buildJavaLexer">
    <java classname="antlr.Tool"
	  fork="yes"
	  failonerror="true"
	  taskname="antlr"
	  dir="${basedir}/src/net/mtu/eggplant/assert">
      <classpath>
  	<pathelement location="${basedir}/lib/antlr.jar" />
      </classpath>
      <arg value="java.g" />
    </java>
  </target>

  <target name="buildAssertLexer" if="buildAssertLexer">
    <java classname="antlr.Tool"
	  fork="yes"
	  failonerror="true"
	  taskname="antlr"
	  dir="${basedir}/src/net/mtu/eggplant/assert">
      <classpath>
        <pathelement location="${basedir}/lib/antlr.jar" />
      </classpath>
      <arg value="assert.g" />
    </java>
  </target>
  
  <target name="compile" depends="init,buildJavaLexer,buildAssertLexer">
    <!-- broken until 1.5 <antlr target="${basedir}/src/net/mtu/eggplant/assert/java.g" /> -->
    <!-- broken until 1.5 <antlr target="${basedir}/src/net/mtu/eggplant/assert/assert.g" /> -->

    <javac srcdir="${basedir}/src" destdir="${basedir}/src" debug="true">
      <classpath>
        <path refid="base.classpath"/>
      </classpath>
      <include name="net/**/*.java"/>
      <exclude name="net/mtu/eggplant/assert/testcases/**"/>
    </javac>
  </target>

  <target name="jar" depends="compile">
    <jar jarfile="${app.name}.jar"
	 basedir="${basedir}/src" includes="**" />
  </target>

  <target name="test" depends="compile">
    <echo message="Look at the output to determine if the tests passed, the build will always succeed" />
    <!-- first instrument the test files -->
    <java fork="yes"
	  classname="net.mtu.eggplant.assert.JonsAssert"
	  taskname="DBC"
	  failonerror="false"> <!-- so we can see what all needs fixing -->
      <arg value="-d ${basedir}/${instrument.dir}" />
      <arg value="-f" />
      <arg value="${basedir}/src/net/mtu/eggplant/assert/testcases" />
      <classpath>
        <pathelement location="${basedir}/src"/>
        <path refid="base.classpath"/>
      </classpath>
    </java>

    <!-- compile newly instrumented files -->
    <javac srcdir="${basedir}/${instrument.dir}" destdir="${basedir}/src" debug="true">
      <classpath>
        <path refid="base.classpath"/>
      </classpath>
      <include name="net/mtu/eggplant/assert/test/**/*.java"/>
    </javac>

    <!-- run tests -->
    <java fork="yes" classname="junit.textui.TestRunner" 
	  taskname="junit" failonerror="false">
      <sysproperty key="ASSERT_BEHAVIOR" value="EXCEPTION" />
      <arg value="net.mtu.eggplant.assert.test.TestAssert"/>
      <classpath>
        <pathelement location="${basedir}/src"/>
        <path refid="base.classpath"/>
      </classpath>
    </java>

    <java fork="yes" classname="junit.textui.TestRunner" 
	  taskname="junit" failonerror="false">
      <sysproperty key="ASSERT_BEHAVIOR" value="EXCEPTION" />
      <sysproperty key="ENFORCE_INHERITED_CONDITIONS" value="FALSE" />
      <arg value="net.mtu.eggplant.assert.test.TestEnforceInherited"/>
      <classpath>
        <pathelement location="${basedir}/src"/>
        <path refid="base.classpath"/>
      </classpath>
    </java>
  </target>

  <target name="instrument" depends="init" if="assert.present">
    <java fork="yes"
	  classname="net.mtu.eggplant.assert.JonsAssert"
	  taskname="assert"
	  failonerror="true">
      <arg value="${basedir}/src/net" />
      <arg value="-d ${basedir}/${instrument.dir}" />
    </java>
  </target>

  <target name="compile-assert" depends="init,instrument">
    <java classname="antlr.Tool"
	  fork="yes"
	  failonerror="true"
	  taskname="antlr"
	  dir="${basedir}/src/net/mtu/eggplant/assert">
      <classpath>
  	<pathelement location="${basedir}/lib/antlr.jar" />
      </classpath>
      <arg value="java.g" />
    </java>

    <java classname="antlr.Tool"
	  fork="yes"
	  failonerror="true"
	  taskname="antlr"
	  dir="${basedir}/src/net/mtu/eggplant/assert">
      <classpath>
        <pathelement location="${basedir}/lib/antlr.jar" />
      </classpath>
      <arg value="assert.g" />
    </java>

    <javac srcdir="${instrument.dir}" destdir="${basedir}/src" debug="true">
      <classpath>
        <path refid="base.classpath"/>
      </classpath>
      <include name="net/**/*.java"/>
      <exclude name="net/mtu/eggplant/assert/testcases/**"/>
    </javac>
  </target>

  <target name="clean">
    <delete>
      <fileset dir="${basedir}/src">
  	<patternset>
  	  <include name="**/*.class" />
  	</patternset>
  	<patternset>
  	  <include name="net/mtu/eggplant/assert/AssertLexer.*" />
  	</patternset>
  	<patternset>
  	  <include name="net/mtu/eggplant/assert/AssertLexerTokenTypes.*" />
  	</patternset>
  	<patternset>
  	  <include name="net/mtu/eggplant/assert/JavaLexer.*" />
  	</patternset>
  	<patternset>
  	  <include name="net/mtu/eggplant/assert/JavaRecognizer.*" />
  	</patternset>
  	<patternset>
      	  <include name="net/mtu/eggplant/assert/JavaTokenTypes.*" />
  	</patternset>
      </fileset>
    </delete>
  </target>

  <!-- Javadoc targets below here -->

  <!-- tell javadoc where to find out doclet -->
  <!--<property name="doclet.name" value="com.honeywell.htc.schedinfra.javadoc.Standard" />
  <property name="doclet.path" value="/home/jpschewe/projects/java/scripts/javadoc.jar" />-->

  <property name="doclet.name" value="net.mtu.eggplant.doclet.Standard" />
  <property name="doclet.path" value="/home/jpschewe/projects/infra/src" />
  
  <!-- used for releases -->
  <property name="mtu.net" value="http://mtu.net/~jpschewe" />
  <property name="mtu.net.offline" value="/home/jpschewe/public_html/mtu.net/public_html" />

  <!-- used for active_javadoc -->
  <property name="active.home.html.dir" value="http://disk.mnt.mtu.net/~jpschewe" />
  <property name="active.html.dir" value="/home/public_html/" />

  <target name="init_javadoc">
    <mkdir dir="${temp.dir}" />
  </target>
  
  
  <!-- 0.2 javadoc -->
  <target name="0.2_javadoc" depends="init_javadoc">
    <!-- get the source out of cvs -->
    <cvs cvsRoot="/home/CVS-Repository"
	 package="assert"
	 dest="${temp.dir}"
	 tag="JonsAssert-0_2" />
    <!-- run javadoc on the source -->
    <mkdir dir="${mtu.net.offline}/JonsAssert/0.2/api" />
    <javadoc packagenames="net.mtu.eggplant.*"
	     sourcepath="${temp.dir}/assert/src"
	     use="true"
	     splitindex="true"
	     version="true"
	     windowtitle="JonsAssert 0.2"
	     destdir="${mtu.net.offline}/JonsAssert/0.2/api">
      <doclet name="${doclet.name}"
	      path="${doclet.path}">
      </doclet>
      <classpath>
	<pathelement location="${temp.dir}/assert/src/" />
	<pathelement location="${temp.dir}/assert/lib/junit.jar" />
	<pathelement location="${temp.dir}/assert/lib/JonsInfra-0.1.jar" />
	<pathelement location="${temp.dir}/assert/lib/antlr.jar" />
	<pathelement location="${temp.dir}/assert/lib/java-getopt-1.0.7.jar" />
      </classpath>
      <!-- core java -->
      <link href="http://java.sun.com/j2se/1.3/docs/api/" />
      <!-- infra -->
      <link offline="true" href="${mtu.net}/JonsInfra/0.1/api" packagelistLoc="${mtu.net.offline}/JonsInfra/0.1/api" />
      <!-- junit -->
      <link offline="true" href="${mtu.net}/java/junit/3.2" packagelistLoc="${mtu.net.offline}/java/junit/3.2" />
      <!-- antlr -->
      <link offline="true" href="${mtu.net}/java/antlr/2.6.0" packagelistLoc="${mtu.net.offline}/java/antlr/2.6.0" />
      <!-- gnu -->
      <link offline="true" href="${mtu.net}/java/gnu" packagelistLoc="${mtu.net.offline}/java/gnu" />
    </javadoc>
    
    <!-- delete the temp files -->
    <delete dir="${temp.dir}" />
  </target>
  
  <!-- 0.3 javadoc -->
  <target name="0.3_javadoc" depends="init_javadoc">
    <!-- get the source out of cvs -->
    <cvs cvsRoot="/home/CVS-Repository"
	 package="assert"
	 dest="${temp.dir}"
	 tag="JonsAssert-0_3" />
    <!-- run javadoc on the source -->
    <mkdir dir="${mtu.net.offline}/JonsAssert/0.3/api" />
    <javadoc packagenames="net.mtu.eggplant.*"
	     sourcepath="${temp.dir}/assert/src"
	     use="true"
	     splitindex="true"
	     version="true"
	     windowtitle="JonsAssert 0.3"
	     destdir="${mtu.net.offline}/JonsAssert/0.3/api" >
      <doclet name="${doclet.name}"
	      path="${doclet.path}">
      </doclet>
      <classpath>
	<pathelement location="${temp.dir}/assert/src/" />
	<pathelement location="${temp.dir}/assert/lib/junit-3.6.jar" />
	<pathelement location="${temp.dir}/assert/lib/JonsInfra-0.1.jar" />
	<pathelement location="${temp.dir}/assert/lib/antlr.jar" />
	<pathelement location="${temp.dir}/assert/lib/werken.opt.jar" />
      </classpath>
      <!-- core java -->
      <link href="http://java.sun.com/j2se/1.3/docs/api/" />
      <!-- infra -->
      <link offline="true" href="${mtu.net}/JonsInfra/0.1/api" packagelistLoc="${mtu.net.offline}/JonsInfra/0.1/api" />
      <!-- junit -->
      <link offline="true" href="${mtu.net}/java/junit/3.6" packagelistLoc="${mtu.net.offline}/java/junit/3.6" />
      <!-- antlr -->
      <link offline="true" href="${mtu.net}/java/antlr/2.6.0" packagelistLoc="${mtu.net.offline}/java/antlr/2.6.0" />
      <!-- werken.opt -->
      <link href="http://code.werken.com/werken.opt/build/apidocs/" />
    </javadoc>
    
    <!-- delete the temp files -->
    <delete dir="${temp.dir}" />
  </target>
    
</project>